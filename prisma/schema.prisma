generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Platform {
  JAVA
  BEDROCK
  CROSSPLAY
}

enum GameMode {
  SURVIVAL
  SKYBLOCK
  FACTION
  TOWNY
  CREATIVE
  MINIGAMES
  PRISON
  KITPVP
  OTHER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum TicketCategory {
  GENERAL
  SUPPORT
  BUG_REPORT
  ADVERTISING
  SPONSORSHIP
  VERIFICATION_REQUEST
  OTHER
}

enum BadgeType {
  CRITIC
  EXPLORER
  VERIFIED_OWNER
  EARLY_ADOPTER
  TOP_VOTER
}

enum BlogType {
  GUIDE
  UPDATE
  NEWS
  TUTORIAL
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String?
  username          String?   @unique
  minecraftNick     String?
  role              Role      @default(USER)
  discordId         String?   @unique
  discordUsername   String?
  avatarUrl         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Gamification
  badges            UserBadge[]
  serverVisits      ServerVisit[]

  servers           Server[]
  tickets           Ticket[]  @relation("UserTickets")
  ticketMessages    TicketMessage[]
  blogPosts         BlogPost[]
  hostings          Hosting[]
  hostingReviews    HostingReview[]

  @@index([email])
  @@index([discordId])
}

// ==================== GAMIFICATION - BADGES ====================
model UserBadge {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeType   BadgeType
  earnedAt    DateTime  @default(now())
  
  @@unique([userId, badgeType])
  @@index([userId])
}

// ==================== SERVER VISIT TRACKING ====================
model ServerVisit {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  serverId    String
  visitedAt   DateTime  @default(now())
  
  @@unique([userId, serverId])
  @@index([userId])
  @@index([serverId])
}

model Server {
  id                String          @id @default(uuid())
  name              String
  ip                String
  port              Int             @default(25565)
  platform          Platform        @default(JAVA)
  gameMode          GameMode        @default(SURVIVAL)
  version           String
  website           String?
  discord           String?
  bannerUrl         String?
  logoUrl           String?
  shortDescription  String
  longDescription   String?         @db.Text
  tags              String[]        @default([])
  
  // Votifier settings
  votifierHost      String?
  votifierPort      Int?
  votifierPublicKey String?         @db.Text
  votifierToken     String?

  // Status
  approvalStatus    ApprovalStatus  @default(PENDING)
  isOnline          Boolean         @default(false)
  playerCount       Int             @default(0)
  maxPlayers        Int             @default(0)
  voteCount         Int             @default(0)
  monthlyVotes      Int             @default(0)

  // Sponsor (legacy)
  isSponsored       Boolean         @default(false)
  sponsoredUntil    DateTime?

  // Analytics
  clickCount        Int             @default(0)
  lastPingedAt      DateTime?

  // Relations
  ownerId           String
  owner             User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  votes             Vote[]
  boosts            ServerBoost[]
  stats             ServerStats[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([approvalStatus])
  @@index([isSponsored])
  @@index([voteCount])
  @@index([platform])
  @@index([gameMode])
  @@index([createdAt])
}

// ==================== SERVER BOOST SYSTEM ====================
model ServerBoost {
  id          String    @id @default(uuid())
  serverId    String
  server      Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  startTime   DateTime  @default(now())
  endTime     DateTime
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  
  @@index([serverId])
  @@index([isActive])
  @@index([endTime])
}

// ==================== SERVER STATS (TIME SERIES) ====================
model ServerStats {
  id          String    @id @default(uuid())
  serverId    String
  server      Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  playerCount Int       @default(0)
  maxPlayers  Int       @default(0)
  isOnline    Boolean   @default(false)
  recordedAt  DateTime  @default(now())
  
  @@index([serverId])
  @@index([recordedAt])
}

model Vote {
  id                String    @id @default(uuid())
  serverId          String
  server            Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  minecraftUsername String
  ipAddress         String
  createdAt         DateTime  @default(now())

  @@index([serverId])
  @@index([ipAddress])
  @@index([createdAt])
}

// ==================== HOSTING SYSTEM ====================
model Hosting {
  id              String          @id @default(uuid())
  name            String
  slug            String          @unique
  website         String
  logoUrl         String?
  description     String
  longDescription String?         @db.Text
  features        String[]        @default([])
  
  // Pricing
  startingPrice   Decimal         @db.Decimal(10, 2)
  currency        String          @default("TRY")
  
  // Status
  isActive        Boolean         @default(true)
  isSponsored     Boolean         @default(false)
  sponsoredUntil  DateTime?
  approvalStatus  ApprovalStatus  @default(PENDING)
  
  // Verified status (admin controlled)
  isVerified      Boolean         @default(false)
  verifiedAt      DateTime?
  
  // Calculated ratings (updated on review)
  avgPerformance  Float           @default(0)
  avgSupport      Float           @default(0)
  avgPriceValue   Float           @default(0)
  avgOverall      Float           @default(0)
  reviewCount     Int             @default(0)
  
  // Relations
  ownerId         String
  owner           User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  reviews         HostingReview[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([approvalStatus])
  @@index([isSponsored])
  @@index([isVerified])
  @@index([avgOverall])
  @@index([slug])
}

model HostingReview {
  id              String    @id @default(uuid())
  hostingId       String
  hosting         Hosting   @relation(fields: [hostingId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Ratings (1-5)
  performance     Int       @default(5)
  support         Int       @default(5)
  priceValue      Int       @default(5)
  comment         String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([hostingId, userId])
  @@index([hostingId])
  @@index([userId])
}

// ==================== BLOG SYSTEM ====================
model BlogCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  description String?
  color       String?   @default("#10b981")
  posts       BlogPost[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
}

model BlogPost {
  id          String        @id @default(uuid())
  title       String
  slug        String        @unique
  content     String        @db.Text
  excerpt     String?
  coverImage  String?
  tags        String[]      @default([])
  published   Boolean       @default(false)
  blogType    BlogType      @default(NEWS)
  authorId    String
  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([slug])
  @@index([published])
  @@index([categoryId])
  @@index([blogType])
  @@index([createdAt])
}

// ==================== TICKET SYSTEM ====================
model Ticket {
  id          String          @id @default(uuid())
  subject     String
  category    TicketCategory  @default(GENERAL)
  status      TicketStatus    @default(OPEN)
  userId      String
  user        User            @relation("UserTickets", fields: [userId], references: [id], onDelete: Cascade)
  messages    TicketMessage[]
  
  // For auto-created tickets (advertising packages)
  packageType String?
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status])
  @@index([userId])
  @@index([category])
}

model TicketMessage {
  id          String    @id @default(uuid())
  content     String    @db.Text
  ticketId    String
  ticket      Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  isAdmin     Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([ticketId])
}

// ==================== BANNER/ADS SYSTEM ====================
model Banner {
  id          String    @id @default(uuid())
  title       String
  subtitle    String?
  imageUrl    String
  linkUrl     String?
  position    String    @default("home_top") // home_top, home_sidebar, header_below, list_between
  isActive    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  priority    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([position])
  @@index([isActive])
}

// ==================== PRICING PACKAGES ====================
model PricingPackage {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String
  price       Decimal   @db.Decimal(10, 2)
  currency    String    @default("TRY")
  duration    Int       @default(30) // Days
  features    String[]  @default([])
  isActive    Boolean   @default(true)
  sortOrder   Int       @default(0)
  packageType String    // HEADER_AD, SIDEBAR_AD, SERVER_SPONSOR, HOSTING_SPONSOR
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
  @@index([packageType])
}

// ==================== SITE SETTINGS ====================
model SiteSettings {
  id              String    @id @default("main")
  discordUrl      String?
  instagramUrl    String?
  youtubeUrl      String?
  twitterUrl      String?
  contactEmail    String?
  updatedAt       DateTime  @updatedAt
}
