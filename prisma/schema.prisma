generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Platform {
  JAVA
  BEDROCK
  CROSSPLAY
}

enum GameMode {
  SURVIVAL
  SKYBLOCK
  FACTION
  TOWNY
  CREATIVE
  MINIGAMES
  PRISON
  KITPVP
  OTHER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String?
  username          String?   @unique
  minecraftNick     String?
  role              Role      @default(USER)
  discordId         String?   @unique
  discordUsername   String?
  avatarUrl         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  servers           Server[]
  tickets           Ticket[]  @relation("UserTickets")
  ticketMessages    TicketMessage[]
  blogPosts         BlogPost[]

  @@index([email])
  @@index([discordId])
}

model Server {
  id                String          @id @default(uuid())
  name              String
  ip                String
  port              Int             @default(25565)
  platform          Platform        @default(JAVA)
  gameMode          GameMode        @default(SURVIVAL)
  version           String
  website           String?
  discord           String?
  bannerUrl         String?
  logoUrl           String?
  shortDescription  String
  longDescription   String?         @db.Text
  tags              String[]        @default([])
  
  // Votifier settings
  votifierHost      String?
  votifierPort      Int?
  votifierPublicKey String?         @db.Text
  votifierToken     String?

  // Status
  approvalStatus    ApprovalStatus  @default(PENDING)
  isOnline          Boolean         @default(false)
  playerCount       Int             @default(0)
  maxPlayers        Int             @default(0)
  voteCount         Int             @default(0)
  monthlyVotes      Int             @default(0)

  // Sponsor
  isSponsored       Boolean         @default(false)
  sponsoredUntil    DateTime?

  // Relations
  ownerId           String
  owner             User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  votes             Vote[]

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([approvalStatus])
  @@index([isSponsored])
  @@index([voteCount])
  @@index([platform])
  @@index([gameMode])
}

model Vote {
  id                String    @id @default(uuid())
  serverId          String
  server            Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  minecraftUsername String
  ipAddress         String
  createdAt         DateTime  @default(now())

  @@index([serverId])
  @@index([ipAddress])
  @@index([createdAt])
}

model BlogCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  description String?
  color       String?   @default("#10b981")
  posts       BlogPost[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
}

model BlogPost {
  id          String        @id @default(uuid())
  title       String
  slug        String        @unique
  content     String        @db.Text
  excerpt     String?
  coverImage  String?
  published   Boolean       @default(false)
  authorId    String
  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([slug])
  @@index([published])
  @@index([categoryId])
}

model Ticket {
  id          String          @id @default(uuid())
  subject     String
  status      TicketStatus    @default(OPEN)
  userId      String
  user        User            @relation("UserTickets", fields: [userId], references: [id], onDelete: Cascade)
  messages    TicketMessage[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status])
  @@index([userId])
}

model TicketMessage {
  id          String    @id @default(uuid())
  content     String    @db.Text
  ticketId    String
  ticket      Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  isAdmin     Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([ticketId])
}

model Banner {
  id          String    @id @default(uuid())
  title       String
  subtitle    String?
  imageUrl    String
  linkUrl     String?
  position    String    @default("home_top")
  isActive    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  priority    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([position])
  @@index([isActive])
}
